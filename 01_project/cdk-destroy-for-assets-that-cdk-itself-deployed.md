---
title: "Check the difference between cdk destroy and deleting from console"
date: 2025-09-25
tags: ["cdk", "aws"]
---

# The problem

The AWS CDK bootstrap bucket stores all kinds of assets and was curious if running `cdk destroy` deleted any of the assets that were deployed by it.

## The way I was testing it

After deploying some basic go lambda using cdk and using `Code.fromAsset`.

```typescript
const myLambda = new lambda.Function(this, "MyLambdaFunction", {
  runtime: lambda.Runtime.PROVIDED_AL2023,
  handler: "bootstrap",
  code: lambda.Code.fromAsset("build"),
  timeout: cdk.Duration.seconds(30),
  memorySize: 128,
});
```

I ended up with two files in the `bootstrap S3`.

- cloudformation template called - `5e865dc78a63281d0706e602b4bcd9333c4947901edbbd3cda9fe045e73dde6e.json`
- go binary - `88078833bde840632928a6c2720692b17ddd9ce51ce963041a8be0b39a2ed955.zip`

The cloudformation template was literally the template that was deployed.

The zipfile's content was literally the contents of the `build` directory.

After the deployment tried to delete the template both via the `AWS Console` directly and both using `cdk destroy`.

> [!IMPORTANT]
> It does not matter which way you delete the cloudformation stack the assets generated by CDK do not get destroyed

## Bootstrap S3 bucket behavior summary

- The bootstrap S3 bucket stores deployment assets (Lambda code, Docker images, etc.)
- Assets accumulate over time with each deployment
- CDK doesn't automatically clean up old assets
- The bucket persists even after destroying all your stacks

## Strategies to clean up assets

1. Manual cleanup (nuke the content's of the bucket)

```sh
aws s3 rm s3://cdk-hnb659fds-assets-{account}-{region} --recursive
```

2. Automated script (to nuke the content's of the bucket)
3. Lifecycle Bucket policy (will auto delete old assets)
4. Run a series of checks for the activerly used assets and remove the ones that are not used

```sh
# list the stacks that are active
aws cloudformation list-stacks --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE UPDATE_ROLLBACK_COMPLETE

# get the details of the stack (for the assets)
aws cloudformation get-template --stack-name your-stack-name

```

For the above example I could find the corresponding zipfile, but not the cloudformation template.

```yaml
"MyLambdaFunction67CCA873": {
  "Type": "AWS::Lambda::Function",
  "Properties": {
    "Code": {
      "S3Bucket": {
        "Fn::Sub": "cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}"
      },
      "S3Key": "88078833bde840632928a6c2720692b17ddd9ce51ce963041a8be0b39a2ed955.zip"
    },
    "Handler": "bootstrap",
    "MemorySize": 128,
    "Role": {
      "Fn::GetAtt": [
        "MyLambdaFunctionServiceRole313A4D46",
        "Arn"
      ]
    },
    "Runtime": "provided.al2023",
    "Timeout": 30
  },
  "DependsOn": [
    "MyLambdaFunctionServiceRole313A4D46"
  ],
```

> [!NOTE]
> Could not find a connection between the deployed cloudformation stack and the template json file in the assets directory
